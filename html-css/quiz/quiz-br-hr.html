<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz â€” &lt;br&gt; &amp; &lt;hr&gt; | MÃ«so Programimin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="quiz.css" />
</head>
<body>

  <div class="page">

    <nav class="topbar">
      <a class="icon-btn" href="../mesimet/lesson0.04.html" aria-label="Kthehu pas">â†</a>

      <div class="topbar-actions">
        <a href="../../dashboard.html" class="icon-btn" title="Dashboard">ğŸ“Š</a>
        <a href="#" class="icon-btn report-bug-link" data-report="bug" title="Report a bug">ğŸ</a>
      </div>

      <div class="topbar-title">
        <p class="tiny">Quiz</p>
        <h1>Tag-et pa mbyllje: &lt;br&gt; &amp; &lt;hr&gt;</h1>
      </div>
      <div class="progress-wrap" aria-label="Progresi i quiz-it">
        <span class="progress-text" id="progressText">1/5</span>
        <div class="progress">
          <div class="progress-bar" id="progressBar" style="width: 20%"></div>
        </div>
      </div>
    </nav>

    <main class="container">

      <section class="card">
        <p class="badge" id="badge">Pyetja 1</p>

        <h2 class="question" id="questionText"></h2>

        <form class="options" id="quizForm"></form>

        <p class="result" id="resultMsg"></p>
      </section>

      <div class="right-actions">
        <button class="btn primary" type="button" id="submitBtn">DÃ«rgo</button>
        <button class="btn ghost hidden" type="button" id="retryBtn">Provo prap</button>
        <button class="btn next" type="button" id="nextBtn" disabled>Vazhdo</button>
      </div>

    </main>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import { markLessonCompleted } from "../../js/courseProgressManager.js";

    const COURSE_SLUG = "html-fundamentals";
    const LESSON_ID = "l9"; // Quiz: <br> & <hr>

    const quizData = [
      {
        badge: "Pyetja 1",
        question: "Cili tag pÃ«rdoret pÃ«r tÃ« kaluar nÃ« rresht tÃ« ri brenda tÃ« njÃ«jtit paragraf?",
        answers: [
          { text: "<br>", correct: true },
          { text: "<hr>", correct: false },
          { text: "<p>", correct: false },
          { text: "<div>", correct: false }
        ]
      },
      {
        badge: "Pyetja 2",
        question: "Cili tag krijon njÃ« vijÃ« horizontale pÃ«r tÃ« ndarÃ« pjesÃ« tÃ« faqes?",
        answers: [
          { text: "<hr>", correct: true },
          { text: "<br>", correct: false },
          { text: "<line>", correct: false },
          { text: "<section>", correct: false }
        ]
      },
      {
        badge: "Pyetja 3",
        question: "Si quhen tag-et si <br> dhe <hr> qÃ« nuk kanÃ« mbyllje?",
        answers: [
          { text: "Void elements", correct: true },
          { text: "Container tags", correct: false },
          { text: "Block elements", correct: false },
          { text: "Inline elements", correct: false }
        ]
      }
    ];

    const badgeEl = document.getElementById("badge");
    const questionEl = document.getElementById("questionText");
    const formEl = document.getElementById("quizForm");
    const resultMsg = document.getElementById("resultMsg");
    const submitBtn = document.getElementById("submitBtn");
    const nextBtn = document.getElementById("nextBtn");
    const retryBtn = document.getElementById("retryBtn");
    const progressText = document.getElementById("progressText");
    const progressBar = document.getElementById("progressBar");

    let current = 0;

    function getOptions() {
      return Array.from(document.querySelectorAll(".option"));
    }

    function resetFeedback() {
      const options = getOptions();
      options.forEach(o => o.classList.remove("correct", "wrong", "disabled"));
      resultMsg.className = "result";
      resultMsg.textContent = "";
    }

    function lockOptions(lock) {
      const options = getOptions();
      options.forEach(o => {
        if (lock) o.classList.add("disabled");
        else o.classList.remove("disabled");
      });
    }

    function updateProgress() {
      const total = quizData.length;
      const currentIndex = current + 1;
      const percent = Math.round((currentIndex / total) * 100);
      progressText.textContent = `${currentIndex}/${total}`;
      progressBar.style.width = `${percent}%`;
    }

    function renderQuestion() {
      const q = quizData[current];

      // reset UI
      resetFeedback();
      submitBtn.disabled = false;

      // Vazhdo gjithmonÃ« i dukshÃ«m, por i mbyllur derisa tÃ« jetÃ« saktÃ«
      nextBtn.disabled = true;

      // Retry fshehur nÃ« fillim
      retryBtn.classList.add("hidden");

      // fill text
      badgeEl.textContent = q.badge;
      questionEl.textContent = q.question;

      // build options
      formEl.innerHTML = "";
      q.answers.forEach((a, idx) => {
        const label = document.createElement("label");
        label.className = "option";
        if (a.correct) label.dataset.correct = "true";

        label.innerHTML = `
          <input type="radio" name="q" value="${idx}">
          <span>${a.text.replaceAll("<", "&lt;").replaceAll(">", "&gt;")}</span>
        `;
        formEl.appendChild(label);
      });

      updateProgress();
    }

    submitBtn.addEventListener("click", () => {
      const options = getOptions();
      const selectedInput = document.querySelector('input[name="q"]:checked');

      resetFeedback();
      nextBtn.disabled = true;
      retryBtn.classList.add("hidden");

      if (!selectedInput) {
        resultMsg.textContent = "Zgjedh njÃ« pÃ«rgjigje para se tÃ« dÃ«rgosh.";
        return;
      }

      const selectedLabel = selectedInput.closest(".option");
      const correctLabel = options.find(o => o.dataset.correct === "true");

      // show correct always
      if (correctLabel) correctLabel.classList.add("correct");

      const isCorrect = selectedLabel === correctLabel;

      if (!isCorrect) {
        selectedLabel.classList.add("wrong");
        resultMsg.textContent = "Gabim âŒ Provo pÃ«rsÃ«ri.";
        resultMsg.classList.add("bad");

        // shfaq Retry dhe Ã§'lejo me provu prap
        retryBtn.classList.remove("hidden");

        // i mbyll opsionet derisa tÃ« shtypet Retry (opsionale)
        lockOptions(true);

        // lejo submit prap (pas retry)
        submitBtn.disabled = false;
      } else {
        resultMsg.textContent = "SaktÃ« âœ… Bravo! Tani mund tÃ« vazhdosh.";
        resultMsg.classList.add("good");

        nextBtn.disabled = false;
        submitBtn.disabled = true;

        // lock options (opsionale)
        lockOptions(true);
      }
    });

    retryBtn.addEventListener("click", () => {
      // pastro feedback, hape opsionet, dhe fsheh retry
      resetFeedback();
      lockOptions(false);
      retryBtn.classList.add("hidden");

      // vazhdo mbetet i mbyllur
      nextBtn.disabled = true;

      // hiq selektimin (opsionale)
      const checked = document.querySelector('input[name="q"]:checked');
      if (checked) checked.checked = false;
    });

    nextBtn.addEventListener("click", () => {
      if (nextBtn.disabled) return;

      if (current < quizData.length - 1) {
        current++;
        renderQuestion();
      } else {
        // Mark quiz as completed before navigating
        (async () => {
          await markLessonCompleted(COURSE_SLUG, LESSON_ID);
          window.location.href = "/html-css/ushtrime/ushtrime0.2.html";
        })();
      }
    });

    renderQuestion();
  </script>

</body>
</html>
